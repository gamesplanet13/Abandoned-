<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Abandoned Cart WhatsApp Sender</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { margin-bottom: 10px; }
    textarea { width: 100%; height: 100px; margin-bottom: 15px; font-size: 14px; }
    input[type='file'] { margin-bottom: 10px; }
    button { padding: 6px 12px; cursor: pointer; border: none; background: #25D366; color: white; border-radius: 4px; margin: 5px 5px 10px 0; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #progressContainer { width: 100%; background: #ddd; border-radius: 5px; margin-bottom: 15px; display: none; }
    #progressBar { width: 0%; height: 20px; background: #25D366; border-radius: 5px; text-align: center; color: white; line-height: 20px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h2>📤 Upload Abandoned Cart Excel</h2>
  <textarea id="customMessage" placeholder="✍️ Paste your WhatsApp message here... Use ${name} to insert customer name."></textarea>
  <br>
  <input type="file" id="excelFile" accept=".xlsx,.xls" />
  <button onclick="generateMessages()">🔄 Generate Messages</button>
  <button onclick="clearSentHistory()">🧹 Clear Sent History</button>
  <div id="progressContainer">
    <div id="progressBar">0%</div>
  </div>
  <table id="outputTable">
    <thead>
      <tr><th>Name</th><th>Mobile</th><th>Send</th></tr>
    </thead>
    <tbody></tbody>
  </table>  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>  <script>
    let fileData;
    const SENT_KEY = 'sent_whatsapp_numbers';
    let sentNumbers = JSON.parse(localStorage.getItem(SENT_KEY) || '[]');

    document.getElementById('excelFile').addEventListener('change', function (e) {
      fileData = e.target.files[0];
    });

    function clearSentHistory() {
      localStorage.removeItem(SENT_KEY);
      sentNumbers = [];
      alert('✅ Sent history cleared! Please regenerate the table.');
    }

    function generateMessages() {
      const userMsg = document.getElementById('customMessage').value.trim();
      if (!userMsg) return alert("Please paste your WhatsApp message.");
      if (!fileData) return alert("Please upload an Excel file.");

      const reader = new FileReader();
      document.getElementById('progressContainer').style.display = 'block';
      updateProgress(0);

      reader.onload = function (event) {
        updateProgress(10);
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        updateProgress(30);
        const tbody = document.querySelector('#outputTable tbody');
        tbody.innerHTML = '';

        const total = json.length;
        let current = 0;
        const batchSize = 100;

        function processBatch() {
          const fragment = document.createDocumentFragment();

          for (let i = 0; i < batchSize && current < total; i++, current++) {
            const row = json[current];
            let name = row['Customer Name'] || row['Name'] || "Customer";
            let mobile = ('' + (row['Mobile Number'] || row['Alternate Mobile Number'] || '')).replace(/\D/g, '').replace(/^0/, '');
            if (!mobile || mobile.length < 10) continue;

            const msg = userMsg.replace(/\$\{name\}/gi, name);
            const encodedMsg = encodeURIComponent(msg);
            const whatsappUrl = `https://wa.me/91${mobile}?text=${encodedMsg}`;

            const isSent = sentNumbers.includes(mobile);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${name}</td>
              <td>${mobile}</td>
              <td><button ${isSent ? 'disabled' : ''} onclick="sendMsg(this, '${whatsappUrl}', '${mobile}')">${isSent ? 'Sent' : 'Send'}</button></td>
            `;
            fragment.appendChild(tr);
          }

          tbody.appendChild(fragment);
          updateProgress(30 + Math.round((70 * current) / total));

          if (current < total) {
            setTimeout(processBatch, 10);
          } else {
            updateProgress(100);
          }
        }

        processBatch();
      };

      reader.readAsArrayBuffer(fileData);
    }

    function sendMsg(button, url, mobile) {
      window.open(url, '_blank');
      button.disabled = true;
      button.innerText = 'Sent';

      if (!sentNumbers.includes(mobile)) {
        sentNumbers.push(mobile);
        localStorage.setItem(SENT_KEY, JSON.stringify(sentNumbers));
      }
    }

    function updateProgress(percent) {
      const bar = document.getElementById('progressBar');
      bar.style.width = percent + '%';
      bar.innerText = percent + '%';
    }
  </script></body>
</html>
